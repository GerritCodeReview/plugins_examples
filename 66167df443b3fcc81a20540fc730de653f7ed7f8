{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "7bb06299_e08c6896",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T18:24:52Z",
      "side": 1,
      "message": "Thanks a lot for the example: it is now very clear to me how it works and is supposed to be used.\nI\u0027ll play with it tonight :-)",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f92d8ba6_72c01f3b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T21:51:58Z",
      "side": 1,
      "message": "@Prudhvi: I tried hard to make it work locally, but it fails for me. Does it work on your environment?\n\nI get:\n1) No implementation for com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory (with no qualifier annotation) was bound, and could not find an injectable constructor. Injectable classes must have either one (and only one) constructor annotated with @Inject or a zero-argument constructor that is not private.\n  at com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory.class(Unknown Source)\n  while locating com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory\n\n1 error\n\tat com.google.inject.internal.InjectorImpl.getProvider(InjectorImpl.java:1120)\n\tat com.google.inject.internal.InjectorImpl.getProvider(InjectorImpl.java:1078)\n\tat com.google.inject.internal.InjectorImpl.getInstance(InjectorImpl.java:1131)\n\tat com.google.gerrit.server.plugins.SharedPluginEnv.instantiate(SharedPluginEnv.java:123)\n\tat com.googlesource.gerrit.plugins.examples.pd.Modules$PdFactory.createPluginDefinedInfos(Modules.java:70)\n",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "365f13c7_48a9c868",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-20T12:20:13Z",
      "side": 1,
      "message": "\u003e Does it work on your environment?\nYes, it is working on my local test site. I have debugged it and verified. I\u0027m also printing a statement in DependencyResolverImpl.java which is showing up in the logs without any errors.. \n\n[2021-03-20T17:07:21.193+05:30] [SSH gerrit query --example-pd--resolve-depends-on change:27 (prudhvi)] ERROR com.googlesource.gerrit.plugins.examples.dependson.DependencyResolverImpl : Inside resolveDependencies, change: 27, 1 deliverables size: 0\n\n\u003e I tried hard to make it work locally, but it fails for me.\nSorry to hear that... I have built the example jars with Java 11 and with \"mvn clean package\" instead of bazel. (this may not help if you are already building it with mvn). I\u0027m running test site with java 11 and I did not test this setup with higher java versions.\n\n\u003e I get:\n\u003e 1) No implementation for com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory (with no qualifier annotation) was bound, and could not find an injectable constructor. Injectable classes must have either one (and only one) constructor annotated with @Inject or a zero-argument constructor that is not private.\n\nLooking at the error, I think it was able to load the class from the merged class loader, since it is trying to instantiate the loaded class from the injector. Looks like the injector was not able to find a valid constructor for PdAttributeFactory, \n\nI think the injector which is trying to instantiate the class is not example-pd\u0027s injector .? (which is not possible if you are using the code as is)\n\nNot sure what it means by \"(with no qualifier annotation) was bound\" in this situation. \n\n\"and could not find an injectable constructor\" which is *not* true, we do have an injectable constructor which is public.\n\nCan you share your environment info..? (java version, how the jars are built)\nCan you kindly let me know if any of this explanation helped you run this setup without errors..?",
      "parentUuid": "f92d8ba6_72c01f3b",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "481fc955_5407b745",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-20T12:28:52Z",
      "side": 1,
      "message": "Working on my local setup.\n\nTest performed: \nrun ssh command, ssh -x -p 29418 localhost gerrit query --example-pd--resolve-depends-on change:27\n\nyou will see the following log entry in the error_log without any errors,\n[2021-03-20T17:07:21.193+05:30] [SSH gerrit query --example-pd--resolve-depends-on change:27 (prudhvi)] ERROR com.googlesource.gerrit.plugins.examples.dependson.DependencyResolverImpl : Inside resolveDependencies, change: 27, 1 deliverables size: 0\n\nAlso, example-pd plugin will output below message in respective plugin section,\n\nplugins:\n    name: example-pd\n    message: Ran dependency resolver\n\nTest site setup:\nJava version: 11\nWar version: https://gerrit-review.googlesource.com/c/gerrit/+/300363\nWar build command: bazel build gerrit\nexample plugins build command: mvn clean package\nSystem OS: macOS Big Sur 11.2.2\nPlugins installed: example-depends-on.jar, example-pd.jar\n\n\n",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "96869be0_f775e112",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-20T22:11:35Z",
      "side": 1,
      "message": "\u003e Working on my local setup.\n\nCan you also try from Eclipse?\nI found out that the problems happens ONLY when you run Gerrit from Eclipse, but if I run it from gerrit.sh it works.\n\nWhen you run from Eclipse the class loaders are slightly different, and possibly the magic done for the request-based reloading of the class isn\u0027t working quite right.",
      "parentUuid": "481fc955_5407b745",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9c7ba06_860b0c56",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-21T23:41:46Z",
      "side": 1,
      "message": "I keep of finding bad surprises :-(\nCan you check if you get the same results?",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "81a9fb99_c7b8d6e3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-21T23:43:05Z",
      "side": 1,
      "message": "There are inconsistencies on how this works inside and outside Eclipse. Also, this solution generates paradox like PdAttributeFactory cannot be cast to a PdAttributeFactory ðŸ˜®",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e8de804_625bd329",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-22T00:40:47Z",
      "side": 1,
      "message": "After having played with it, I believe I grasped the overall logic of the approach, but *please* correct me if I am wrong or have misunderstood anything.\n\n1. The two plugins are loaded *independently* with two different injectors and independent class loaders.\n\n2. If example-pd wants to invoke a method of example-depends-on, needs to *reload itself* by mixing its class-loader with the one of example-depends-on, resulting in a \"temporary new plugin\" with other classes obtained with the mixing of the two plugins context.\n\n3. The point 2. creates the paradox that PdAttributeFactory (new plugin\u0027s classes loaded with the mixed class-loader) cannot be casted to PdAttributeFactory (the current plugin with independent class-loader).\n\n4. The two classes (PdAttributeFactory-mixed and PdAttributeFactory-independent) can still be used together when they are casted to a super-class that is contained in Gerrit core.\n\n5. The new mixed class-loader plugin exists only for the duration of the API call and then is left to the JVM to be garbage collected.\n\n6. Every invocation creates a mixed class-loader and a new definition of PdAttributeFactory-mixed class.\n\n7. The meta-space would eventually collapse as the PdAttributeFactory classes will be created and loaded over and over again.\n\nIs any of the above incorrect? Can you provide your view on them?",
      "parentUuid": "81a9fb99_c7b8d6e3",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bf6b231b_0a24d856",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T06:10:55Z",
      "side": 1,
      "message": "\u003e 1. The two plugins are loaded *independently* with two different injectors and independent class loaders.\nTrue.\n\n\u003e 2. If example-pd wants to invoke a method of example-depends-on, needs to *reload itself* by mixing its class-loader with the one of example-depends-on, resulting in a \"temporary new plugin\" with other classes obtained with the mixing of the two plugins context.\nYes, but the part where you mentioned \"needs to *reload itself*\", might not be true as the class PdAttributeFactory is never loaded in example-pd plugin since it is not mentioned anywhere in the example-pd module.\n\n\u003e 3. The point 2. creates the paradox that PdAttributeFactory (new plugin\u0027s classes loaded with the mixed class-loader) cannot be casted to PdAttributeFactory (the current plugin with independent class-loader).\nI believe that is the intent of the design that PdAttributeFactory is never loaded by example-pd plugin and always gets loaded in a temporary shared plugin environment.\n\n\u003e 4. The two classes (PdAttributeFactory-mixed and PdAttributeFactory-independent) can still be used together when they are casted to a super-class that is contained in Gerrit core.\nTrue, but we believe there could be potential miss understanding here. The reason why we are using ChangePluginDefinedInfoFactory is to have a common interface between the current plugin and the temporary plugin, and the common interface *need not* be known to core. In other words we could potentially have an interface which is known to the current plugin and the temporary plugin and the whole setup would still work.\n\n\n\u003e 5. The new mixed class-loader plugin exists only for the duration of the API call and then is left to the JVM to be garbage collected.\nTrue.\n\n\u003e 6. Every invocation creates a mixed class-loader and a new definition of PdAttributeFactory-mixed class.\nNot true. We have a caching mechanism in place which would cache the mixed class loader and returns that class loader unless it is garbage collected. A new definition of the PdAttributeFactory-mixed class is not created always, since the cached mixed class loader would already have the class loaded so it won\u0027t try to load it again.\n\n\u003e 7. The meta-space would eventually collapse as the PdAttributeFactory classes will be created and loaded over and over again.\nNot true. We don\u0027t see a reason why this will happen if we handle the leaks in the right manner. Adding to that, we have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.",
      "parentUuid": "9e8de804_625bd329",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "854e18ae_d63af777",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T06:10:55Z",
      "side": 1,
      "message": "\u003e Can you also try from Eclipse?\nI\u0027m not sure how to run Gerrit with Eclipse. Need to check on that. Do we have a document which formally supports running Gerrit server from Eclipse.?",
      "parentUuid": "96869be0_f775e112",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d0faa6f_bbf57af9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-23T11:37:11Z",
      "side": 1,
      "message": "\u003e \u003e 2. If example-pd wants to invoke a method of example-depends-on, needs to *reload itself* by mixing its class-loader with the one of example-depends-on, resulting in a \"temporary new plugin\" with other classes obtained with the mixing of the two plugins context.\n\n\u003e Yes, but the part where you mentioned \"needs to *reload itself*\", might not be true as the class PdAttributeFactory is never loaded in example-pd plugin since it is not mentioned anywhere in the example-pd module.\n\nGotcha, will do more testing on it. Thanks for checking.\n\n\u003e \u003e 4. The two classes (PdAttributeFactory-mixed and PdAttributeFactory-independent) can still be used together when they are casted to a super-class that is contained in Gerrit core.\n\u003e True, but we believe there could be potential miss understanding here. The reason why we are using ChangePluginDefinedInfoFactory is to have a common interface between the current plugin and the temporary plugin, and the common interface *need not* be known to core. In other words we could potentially have an interface which is known to the current plugin and the temporary plugin and the whole setup would still work.\n\nThanks for clarifying, do you have another example that doesn\u0027t use an interface known to Gerrit core?\n\n\u003e \u003e 6. Every invocation creates a mixed class-loader and a new definition of PdAttributeFactory-mixed class.\n\n\u003e Not true. We have a caching mechanism in place which would cache the mixed class loader and returns that class loader unless it is garbage collected. A new definition of the PdAttributeFactory-mixed class is not created always, since the cached mixed class loader would already have the class loaded so it won\u0027t try to load it again.\n\nDo you have an example of the caching mechanism or a pointer to it?\n\n\u003e \u003e 7. The meta-space would eventually collapse as the PdAttributeFactory classes will be created and loaded over and over again.\n\n\u003e Not true. We don\u0027t see a reason why this will happen if we handle the leaks in the right manner. Adding to that, we have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.\n\nAre you running this PoC in production and monitoring the meta-space growth?",
      "parentUuid": "bf6b231b_0a24d856",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "90d982b5_b0ec16a6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-23T11:37:11Z",
      "side": 1,
      "message": "Please find the Gerrit contributors guide at [1] and the Eclipse setup at [2].\nOnce you have a working development environment in Eclipse, the gerrit daemon is one of the run/debug targets configured.\n\n[1] https://gerrit-documentation.storage.googleapis.com/Documentation/3.3.2/dev-community.html#how-to-contribute\n[2] https://gerrit-documentation.storage.googleapis.com/Documentation/3.3.2/dev-readme.html#_configuring_eclipse",
      "parentUuid": "854e18ae_d63af777",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9b4cf743_fad56881",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T14:32:46Z",
      "side": 1,
      "message": "\u003e \u003e \u003e 4. The two classes (PdAttributeFactory-mixed and PdAttributeFactory-independent) can still be used together when they are casted to a super-class that is contained in Gerrit core.\n\u003e \u003e True, but we believe there could be potential miss understanding here. The reason why we are using ChangePluginDefinedInfoFactory is to have a common interface between the current plugin and the temporary plugin, and the common interface *need not* be known to core. In other words we could potentially have an interface which is known to the current plugin and the temporary plugin and the whole setup would still work.\n\u003e \n\u003e Thanks for clarifying, do you have another example that doesn\u0027t use an interface known to Gerrit core?\nNot as of now. I can try to upload one.\n\u003e \n\u003e \u003e \u003e 6. Every invocation creates a mixed class-loader and a new definition of PdAttributeFactory-mixed class.\n\u003e \n\u003e \u003e Not true. We have a caching mechanism in place which would cache the mixed class loader and returns that class loader unless it is garbage collected. A new definition of the PdAttributeFactory-mixed class is not created always, since the cached mixed class loader would already have the class loaded so it won\u0027t try to load it again.\n\u003e \n\u003e Do you have an example of the caching mechanism or a pointer to it?\n\nEnd of this file [1] we have method \"getMergedClassLoader\" which is performing the caching. \n\n[1] https://gerrit-review.googlesource.com/c/gerrit/+/300363/1/java/com/google/gerrit/server/plugins/SharedPluginEnv.java\n\n\u003e \n\u003e \u003e \u003e 7. The meta-space would eventually collapse as the PdAttributeFactory classes will be created and loaded over and over again.\n\u003e \n\u003e \u003e Not true. We don\u0027t see a reason why this will happen if we handle the leaks in the right manner. Adding to that, we have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.\n\u003e \n\u003e Are you running this PoC in production and monitoring the meta-space growth?\nNot this PoC code. In Gerrit core we have DynamicOptions class [1], which has similar caching but with different kind of mixed class loader (only delegate). We are using this mechanism in our production servers since long time, as mentioned in [2] (end of command options section).\n\n[1] https://gerrit.googlesource.com/gerrit/+/refs/heads/master/java/com/google/gerrit/server/DynamicOptions.java\n\n[2] https://gerrit-review.googlesource.com/Documentation/dev-plugins.html#command_options",
      "parentUuid": "2d0faa6f_bbf57af9",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9bfccb5a_91614c0c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-25T15:28:01Z",
      "side": 1,
      "message": "\u003e \u003e \u003e \u003e 4. The two classes (PdAttributeFactory-mixed and PdAttributeFactory-independent) can still be used together when they are casted to a super-class that is contained in Gerrit core.\n\u003e \u003e \u003e True, but we believe there could be potential miss understanding here. The reason why we are using ChangePluginDefinedInfoFactory is to have a common interface between the current plugin and the temporary plugin, and the common interface *need not* be known to core. In other words we could potentially have an interface which is known to the current plugin and the temporary plugin and the whole setup would still work.\n\u003e \u003e \n\u003e \u003e Thanks for clarifying, do you have another example that doesn\u0027t use an interface known to Gerrit core?\n\u003e Not as of now. I can try to upload one.\n\nUploaded here : Ieaebb92a49821811515e7b51481cac30facb4a8d",
      "parentUuid": "9b4cf743_fad56881",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dcb4b6d0_e38e78b0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-26T12:25:57Z",
      "side": 1,
      "message": "Fails on this one in Eclipse but works in the follow-up change Change-Id: I6f1136023",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e2b4f6f_738300aa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-26T12:25:57Z",
      "side": 1,
      "message": "The Change-Id: I6f1136023 example works E2E in Eclipse as well, because it relies on a standard plugin loading mechanism that is designed to work also in environments where the class loading is done in a slightly different way like in your IDE.",
      "parentUuid": "90d982b5_b0ec16a6",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d6cb7853_99b6c9db",
        "filename": "example-depends-on/src/main/java/com/googlesource/gerrit/plugins/examples/dependson/extensions/DependencyResolver.java",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T18:24:52Z",
      "side": 1,
      "message": "This interface is duplicated between the two plugins (examples-depends-on and examples-pd): is this by design?",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "57318e40_34cef7a0",
        "filename": "example-depends-on/src/main/java/com/googlesource/gerrit/plugins/examples/dependson/extensions/DependencyResolver.java",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-20T12:20:13Z",
      "side": 1,
      "message": "Yes, the interface needs to be shared between two plugins, so that the API consuming plugin can type cast to it and access respective APIs. Also it is being shared through a symbolic link in this example.",
      "parentUuid": "d6cb7853_99b6c9db",
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dabf3710_2f3dbf1d",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 65,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-21T23:41:46Z",
      "side": 1,
      "message": "There is a type-safety warning here, as you don\u0027t have a compiler type checking that what is returned by the instantiate method *is actually* of a subtype of ChangePluginDefinedInfoFactory.\n\nWhat is really surprising is that casting to com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory would even generate a class cast exception :-O\n\nSee below what happens if you do it:\n\njava.lang.ClassCastException: class com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory cannot be cast to class com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory (com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory is in unnamed module of loader com.google.gerrit.server.plugins.DelegatingClassLoader @48267c67; com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory is in unnamed module of loader java.net.FactoryURLClassLoader @7f0b2bf1)\n\nI believe that is a symptom that what we are doing here is still quite fragile.",
      "range": {
        "startLine": 64,
        "startChar": 8,
        "endLine": 65,
        "endChar": 44
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9203b05_4e55030e",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 65,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T06:10:55Z",
      "side": 1,
      "message": "\u003e What is really surprising is that casting to com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory would even generate a class cast exception :-O\nYes, we expect that to happen, as the PdAttributeFactory class loaded by temporary plugin and the current plugin are different as their class loaders are different. Thus we expect the casting to fail.",
      "parentUuid": "dabf3710_2f3dbf1d",
      "range": {
        "startLine": 64,
        "startChar": 8,
        "endLine": 65,
        "endChar": 44
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2ee8e081_a5f82ef1",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T18:24:52Z",
      "side": 1,
      "message": "I see: you have the com.googlesource.gerrit.plugins.examples.pd.PdAttributeFactory Class in the plugin class loader, however, it isn\u0027t loaded with the dependency on the other plugin and therefore isn\u0027t usable as-is.\n\nBy passing the class name as a String (instead of a Class) you then create a merged class loader and ask to reload the class *again* so that it can be resolved against the two plugins class loaders.\n\nAt the end you cast the result onto an interface known to Gerrit that is parent of both classes (the original PdAttributeFactory and the reloaded PdAttributeFactory from the merged class loader).\n\nIs my understanding correct on why you specify a class by name and not by passing the actual Class object?",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b42d7391_97f746de",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T21:51:58Z",
      "side": 1,
      "message": "There is a dangerous side-effect in instantiating the object in this way: every method invocation would result in creating a brand-new class in memory.\n\nI tried printing them out:\n- id of PdAttributeFactory (from the plugin\u0027s class loader)\n  Class PdAttributeFactory \u003d 1257474952\n- id of PdAttributesFactory (for 2 different instantiations)\n  Class PdAttributeFactory \u003d 775894354\n  Class PdAttributeFactory \u003d 1220390123\n\nHave you checked that you won\u0027t risk to overflow the meta-space in this way?\nThat is actually one of the problems we faced when I introduced the Gerrit plugin loader: we got so much used to its dynamic loading/reloading mechanism, that we were quickly breaking the Gerrit meta-space (PermGen at that time, we were on Java 7 back in 2012).",
      "parentUuid": "2ee8e081_a5f82ef1",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67971844_7bbdc117",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T06:10:55Z",
      "side": 1,
      "message": "\u003e every method invocation would result in creating a brand-new class in memory.\nWe believe that caching should have taken care of this scenario, if it is not, it might be a bug or the mixed class loader got garbage collected.\n\n\u003e Have you checked that you won\u0027t risk to overflow the meta-space in this way?\nNeed to test it for this code. But we believe this should not happen if we code the caching right and without any leaks. We have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.",
      "parentUuid": "b42d7391_97f746de",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9afef258_6918d87c",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-23T11:37:11Z",
      "side": 1,
      "message": "\u003e \u003e every method invocation would result in creating a brand-new class in memory.\n\u003e We believe that caching should have taken care of this scenario, if it is not, it might be a bug or the mixed class loader got garbage collected.\n\nAre you possibly running a different code in production? Can you give me a pointer to it so that I can check?\n\n\u003e \u003e Have you checked that you won\u0027t risk to overflow the meta-space in this way?\n\u003e Need to test it for this code. But we believe this should not happen if we code the caching right and without any leaks. We have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.\n\nI believe it would still be sensible to test.",
      "parentUuid": "67971844_7bbdc117",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f072163a_4e1c3bf7",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-23T14:32:46Z",
      "side": 1,
      "message": "\u003e \u003e \u003e every method invocation would result in creating a brand-new class in memory.\n\u003e \u003e We believe that caching should have taken care of this scenario, if it is not, it might be a bug or the mixed class loader got garbage collected.\n\u003e \n\u003e Are you possibly running a different code in production? Can you give me a pointer to it so that I can check?\n\n[1] https://gerrit.googlesource.com/gerrit/+/refs/heads/master/java/com/google/gerrit/server/DynamicOptions.java\n\n[2] https://gerrit-review.googlesource.com/Documentation/dev-plugins.html#command_options (Last paragraph)\n\n\u003e \n\u003e \u003e \u003e Have you checked that you won\u0027t risk to overflow the meta-space in this way?\n\u003e \u003e Need to test it for this code. But we believe this should not happen if we code the caching right and without any leaks. We have similar \"weak reference caching\" of mixed class loaders in production and is working without any issues.\n\u003e \n\u003e I believe it would still be sensible to test.\n\nYes, I\u0027ll test it.",
      "parentUuid": "9afef258_6918d87c",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "826c1ab4_80841f4c",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-26T12:25:57Z",
      "side": 1,
      "message": "If you look at Change-Id: I6f1136023 the problem is resolved, because the class loading is left to the plugin loader and therefore all invocations would use the same class, unless the plugin gets reloaded.\n\nAlso, this part of code because a lot simpler and more natural for a plugin developer, as there is no need to explicitly instantiate anything: just inject and it works.",
      "parentUuid": "f072163a_4e1c3bf7",
      "range": {
        "startLine": 69,
        "startChar": 33,
        "endLine": 69,
        "endChar": 97
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a9b035e5_38f9a608",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-19T18:24:52Z",
      "side": 1,
      "message": "This is the graceful failure if the other plugin doesn\u0027t exist or the class is not there, correct?",
      "range": {
        "startLine": 72,
        "startChar": 8,
        "endLine": 72,
        "endChar": 34
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9317494f_6f0f4b82",
        "filename": "example-pd/src/main/java/com/googlesource/gerrit/plugins/examples/pd/Modules.java",
        "patchSetId": 1
      },
      "lineNbr": 72,
      "author": {
        "id": 1096442
      },
      "writtenOn": "2021-03-20T12:20:13Z",
      "side": 1,
      "message": "Yes, I believe the user can decide on how he wants to handle these exceptions based on the severity of the operation he is performing.\n\nAlso the user can perform error handling while he is trying to fetch the respective API from the other plugin (i.e., when pluginProvidedApis.get(Modules.DEPENDS_ON_PLUGIN, \"DependencyResolver\")).",
      "parentUuid": "a9b035e5_38f9a608",
      "range": {
        "startLine": 72,
        "startChar": 8,
        "endLine": 72,
        "endChar": 34
      },
      "revId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ],
  "submitRequirementResults": [
    {
      "submitRequirement": {
        "name": "Code-Review",
        "description": {
          "value": "At least one maximum vote for label \u0027Code-Review\u0027 is required"
        },
        "applicabilityExpression": {},
        "submittabilityExpression": {
          "expressionString": "label:Code-Review\u003dMAX,user\u003dnon_uploader AND -label:Code-Review\u003dMIN"
        },
        "overrideExpression": {},
        "allowOverrideInChildProjects": true
      },
      "applicabilityExpressionResult": {},
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"label:Code-Review=MAX,user=non_uploader AND -label:Code-Review=MIN"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["label:Code-Review=MAX,user=non_uploader","label:Code-Review=MIN"]}
      },
      "overrideExpressionResult": {},
      "patchSetCommitId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    },
    {
      "submitRequirement": {
        "name": "Do-Not-Submit",
        "description": {
          "value": "Changes that have DO NOT SUBMIT in their commit message are not submittable."
        },
        "applicabilityExpression": {
          "value": {
            "expressionString": "message:\"^.*(D|d)(O|o) (N|n)(O|o)(T|t) (S|s)(U|u)(B|b)(M|m)(I|i)(T|t).*\""
          }
        },
        "submittabilityExpression": {
          "expressionString": "is:false"
        },
        "overrideExpression": {},
        "allowOverrideInChildProjects": false
      },
      "applicabilityExpressionResult": {
        "value": {"expression":{"expressionString":"message:\"^.*(D|d)(O|o) (N|n)(O|o)(T|t) (S|s)(U|u)(B|b)(M|m)(I|i)(T|t).*\""},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["message:\"^.*(D|d)(O|o) (N|n)(O|o)(T|t) (S|s)(U|u)(B|b)(M|m)(I|i)(T|t).*\""]}
      },
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"is:false"},"status":"NOT_EVALUATED","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":[]}
      },
      "overrideExpressionResult": {},
      "patchSetCommitId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    },
    {
      "submitRequirement": {
        "name": "No-Unresolved-Comments",
        "description": {
          "value": "Changes that have unresolved comments are not submittable. Unless overriden by adding the hashtag allow-unresolved-comments."
        },
        "applicabilityExpression": {
          "value": {
            "expressionString": "has:unresolved"
          }
        },
        "submittabilityExpression": {
          "expressionString": "-has:unresolved"
        },
        "overrideExpression": {
          "value": {
            "expressionString": "hashtag:allow-unresolved-comments"
          }
        },
        "allowOverrideInChildProjects": false
      },
      "applicabilityExpressionResult": {
        "value": {"expression":{"expressionString":"has:unresolved"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":["has:unresolved"],"failingAtoms":[]}
      },
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"-has:unresolved"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":["has:unresolved"],"failingAtoms":[]}
      },
      "overrideExpressionResult": {
        "value": {"expression":{"expressionString":"hashtag:allow-unresolved-comments"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["hashtag:allow-unresolved-comments"]}
      },
      "patchSetCommitId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    },
    {
      "submitRequirement": {
        "name": "Review-Enforcement",
        "description": {
          "value": "Two Google employees must approve the change. Uploading the change or voting positively on Code-Review count as approval."
        },
        "applicabilityExpression": {
          "value": {
            "expressionString": "is:review-enforced_gerrit"
          }
        },
        "submittabilityExpression": {
          "expressionString": "is:review-enforcement-satisfied_gerrit"
        },
        "overrideExpression": {},
        "allowOverrideInChildProjects": false
      },
      "applicabilityExpressionResult": {
        "value": {"expression":{"expressionString":"is:review-enforced_gerrit"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["is:review-enforced_gerrit"]}
      },
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"is:review-enforcement-satisfied_gerrit"},"status":"NOT_EVALUATED","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":[]}
      },
      "overrideExpressionResult": {},
      "patchSetCommitId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    },
    {
      "submitRequirement": {
        "name": "Verified",
        "description": {
          "value": "CI result status for build and tests is passing"
        },
        "applicabilityExpression": {
          "value": {
            "expressionString": "-branch:refs/meta/config"
          }
        },
        "submittabilityExpression": {
          "expressionString": "label:Verified\u003dMAX AND -label:Verified\u003dMIN"
        },
        "overrideExpression": {},
        "allowOverrideInChildProjects": true
      },
      "applicabilityExpressionResult": {
        "value": {"expression":{"expressionString":"-branch:refs/meta/config"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["branch:refs/meta/config"]}
      },
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"label:Verified=MAX AND -label:Verified=MIN"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":["label:Verified=MAX","label:Verified=MIN"],"failingAtoms":[]}
      },
      "overrideExpressionResult": {},
      "patchSetCommitId": "66167df443b3fcc81a20540fc730de653f7ed7f8",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    }
  ]
}